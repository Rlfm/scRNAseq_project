---
title: "integration"
format: html
editor: visual
---

```{r}
library(Seurat)
library(clustree)
library(dplyr)
library(tidyr)
library(tibble)
library(ggplot2)
library(stringr)

# visualization config
options(bitmapType="cairo")

set.seed(1)

```


```{r}
retina.scrna <- readRDS("../data/retina.preprocessed_ASL1.rds")

retina.scrna@meta.data <- retina.scrna@meta.data |> 
  mutate(
    embryo = str_sub(sample, 1, 2),
    timepoint = case_when(
      grepl("RPE", sample) ~ "0h",
      grepl("6h", sample) ~ "6h",
      grepl("24h", sample) ~ "24h"
    ),
    condition = case_when(
      grepl("FGF", sample) ~ "fgf",
      grepl("RPE", sample) ~ "ref"
    ) |> 
    mutate(condition = if_else(is.na(condition), "rect", condition))
  )
```

```{r}
retina.scrna <- SCTransform(
  retina.scrna, vars.to.regress = c("percent.mt","diff_S_G2M","percent.W"), ncells = 3000, conserve.memory = TRUE, verbose = TRUE)
```




```{r}
retina.scrna <- RunPCA(retina.scrna, features = VariableFeatures(object = retina.scrna))
retina.scrna <- FindNeighbors(retina.scrna, dims=1:15)
retina.scrna <- FindClusters(retina.scrna, resolution = c(0.2))
retina.scrna <- RunUMAP(retina.scrna, dims = 1:15)


DimPlot(retina.scrna, group.by = "condition")
```
```{r}
DimPlot(retina.scrna, group.by = "SCT_snn_res.0.2")
```

```{r}
retina.scrna_sep <- SplitObject(retina.scrna, split.by = "condition")
retina.scrna_sep <- PrepSCTIntegration(retina.scrna_sep, anchor.features = 2000)
anchor_features <- SelectIntegrationFeatures(object.list = retina.scrna_sep)
integration_anchors <- FindIntegrationAnchors(object.list = retina.scrna_sep, normalization.method = "SCT", anchor.features = anchor_features)
retina.scrna.combined <- IntegrateData(anchorset = integration_anchors)
DefaultAssay(retina.scrna.combined) <- "integrated"
```

```{r}
# Run the standard workflow for visualization and clustering
retina.scrna.combined <- ScaleData(retina.scrna.combined, verbose = FALSE)
retina.scrna.combined <- RunPCA(retina.scrna.combined, npcs = 30, verbose = FALSE)
retina.scrna.combined <- RunUMAP(retina.scrna.combined, reduction = "pca", dims = 1:15)
retina.scrna.combined <- FindNeighbors(retina.scrna.combined, reduction = "pca", dims = 1:15)
retina.scrna.combined <- FindClusters(retina.scrna.combined, resolution = c(0.1, 0.12, 0.18, 0.2))
```

```{r}
DimPlot(retina.scrna.combined, group.by = "condition")
```

```{r}
DimPlot(retina.scrna.combined, group.by = "integrated_snn_res.0.12")
```

```{r}
DimPlot(retina.scrna.combined, group.by = "integrated_snn_res.0.2")
```

```{r}
saveRDS(retina.scrna.combined, "../data/retina.integrated.ASL1.rds")
```

